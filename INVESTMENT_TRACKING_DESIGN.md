# Investment Tracking vs Gains - Design Document

## Problem Statement

Currently, the system shows **new deposits as gains**. When you invest $10,000 and buy stocks, the next snapshot shows this as a $10,000 "gain" instead of recognizing it as new capital.

## Solution Overview

We're implementing a comprehensive tracking system that separates:
- üí∞ **Capital (deposits/withdrawals)** - Money in/out of accounts
- üìà **True Gains/Losses** - Actual investment performance
- üìä **Transaction History** - All account activities over time

## Database Schema

### New Tables

1. **cash_flows** - Track deposits and withdrawals
   - `flow_type`: DEPOSIT or WITHDRAWAL
   - `amount`: Dollar amount
   - `flow_date`: When it occurred
   - Links to account

2. **detected_transactions** - Auto-detected trading activity
   - `transaction_type`: BUY, SELL, DIVIDEND, SPLIT, OTHER
   - `ticker`: Stock symbol
   - `quantity`, `price`, `amount`
   - `from_snapshot_date` / `to_snapshot_date`: Between which snapshots
   - Auto-generated by comparing consecutive CSV imports

3. **Updated accounts table**
   - Added `total_deposits`: Cumulative deposits
   - Added `total_withdrawals`: Cumulative withdrawals

### New Views

1. **account_true_performance** - Calculate true gains excluding deposits
   ```
   True Gain/Loss = Current Value - (Total Deposits - Total Withdrawals)
   True Gain/Loss % = True Gain/Loss / Net Deposits √ó 100
   ```

2. **account_activity** - Unified view of all activity
   - Combines transactions and cash flows
   - Sorted by date
   - Shows complete account history

## How It Works

### Transaction Detection (Automatic)

When you import a new CSV snapshot, the system compares it to the previous snapshot:

1. **New Holdings** ‚Üí Detected as BUY
   - Ticker appears in new snapshot but not in previous
   - Creates BUY transaction

2. **Removed Holdings** ‚Üí Detected as SELL
   - Ticker existed in previous but not in new snapshot
   - Creates SELL transaction

3. **Quantity Changes**
   - Increase ‚Üí Additional BUY transaction
   - Decrease ‚Üí Partial SELL transaction

4. **Price Changes (No Quantity Change)**
   - Not a transaction, just market movement
   - No transaction created

### Cash Flow Management (Manual Entry)

For accurate tracking, you'll manually log:
- **Deposits**: When you add money to an account
- **Withdrawals**: When you take money out

The system will then correctly calculate true performance.

## New Features

### 1. Transaction History Tab

Shows all account activity:
```
Date       | Type       | Ticker | Quantity | Amount    | Description
-----------|------------|--------|----------|-----------|-------------
2026-02-07 | DEPOSIT    | -      | -        | $10,000   | Monthly contribution
2026-02-07 | BUY        | AAPL   | 50       | $5,000    | Auto-detected from snapshot
2026-02-05 | SELL       | GOOGL  | 10       | $3,200    | Auto-detected from snapshot
2026-02-01 | DIVIDEND   | MSFT   | -        | $125      | Auto-detected from snapshot
```

### 2. True Performance Display

**Old (Incorrect):**
```
Market Value: $100,000
Book Value:   $90,000
Gain/Loss:    $10,000 (11.1%)  ‚Üê WRONG if you deposited $8,000
```

**New (Correct):**
```
Current Value:    $100,000
Net Deposits:     $92,000  (Deposits: $95,000 - Withdrawals: $3,000)
True Gain/Loss:   $8,000   (8.7%)  ‚Üê CORRECT!
Book Value:       $92,000  (for reference)
```

### 3. Performance Chart with Markers

Chart shows account value over time with overlaid markers for:
- üü¢ **Deposits** (green markers)
- üî¥ **Withdrawals** (red markers)
- üîµ **Major transactions** (blue markers for large buys/sells)

This helps you see correlation between actions and performance.

### 4. API Endpoints

**Cash Flows:**
- `POST /api/accounts/:id/cash-flows` - Log deposit/withdrawal
- `GET /api/accounts/:id/cash-flows` - Get all cash flows

**Transactions:**
- `GET /api/accounts/:id/transactions` - Get detected transactions
- `GET /api/accounts/:id/activity` - Get all activity (unified view)

**Performance:**
- `GET /api/accounts/:id/true-performance` - Get true performance metrics
- `GET /api/portfolios/:id/true-performance` - Get portfolio-wide true performance

## User Workflow

### Step 1: Import CSV (As Usual)
```bash
1. Navigate to Accounts
2. Click "Import CSV"
3. Select your CSV file
4. Import
```
The system auto-detects transactions by comparing to previous snapshot.

### Step 2: Log Cash Flows (New)
```bash
1. Navigate to account detail
2. Go to "Cash Flows" tab
3. Click "Add Deposit" or "Add Withdrawal"
4. Enter amount and date
5. Save
```

### Step 3: View True Performance
```bash
1. Accounts page shows:
   - Net Deposits: $95,000
   - Current Value: $103,500
   - True Gain: $8,500 (8.9%)  ‚Üê Correct!

2. Transaction History tab shows:
   - All deposits/withdrawals
   - All detected buys/sells
   - Complete activity timeline
```

## Example Scenario

### Your Situation:
- Last week you deposited $10,000
- Bought AAPL shares with it
- Current snapshot shows $10,000 more value

### Old System (Incorrect):
```
Book Value:     $100,000
Market Value:   $110,000
Gain/Loss:      $10,000  ‚Üê WRONG! This is your deposit, not gain
```

### New System (Correct):
```
Previous Value:       $100,000
Deposit:              $10,000
New Net Deposits:     $110,000
Current Market Value: $110,500
True Gain:            $500     ‚Üê CORRECT! Only $500 real gain
True Gain %:          0.45%
```

Plus, Transaction History shows:
```
2026-02-07: DEPOSIT $10,000
2026-02-07: BUY AAPL 36 shares @ $277.78
```

## Implementation Status

‚úÖ **Completed:**
- Database schema designed
- Migration created
- Rust models created
- Database query functions created

üîÑ **In Progress:**
- Transaction detection service (comparing snapshots)
- API endpoints for cash flows and transactions
- CSV import integration

‚è≥ **Next Steps:**
- Frontend UI for cash flow entry
- Transaction history tab UI
- Updated performance display
- Chart with deposit/withdrawal markers

## Migration Path

### For Existing Users:

1. **Run Migration**: Adds new tables and columns
2. **Initial Deposits**: You'll need to manually enter your initial deposits for each account
   - This is a one-time setup
   - Tells the system your starting capital
3. **Future Imports**: System auto-detects transactions going forward
4. **Regular Updates**: Log deposits/withdrawals as they occur

### Setting Initial Deposits

For accurate historical tracking:
```
Account: RRSP
Initial deposit: $50,000 (when you opened the account)
Current value: $65,000
System calculates: True gain = $15,000 (30%)
```

## Benefits

‚úÖ **Accurate Performance Tracking** - Know your true returns
‚úÖ **Complete Transaction History** - See every account activity
‚úÖ **Deposit vs Gain Separation** - No more confusion
‚úÖ **Tax Reporting Ready** - Transaction log helps with taxes
‚úÖ **Multiple Timeframes** - Track performance over any period
‚úÖ **Money-Weighted Returns** - Accounts for timing of cash flows

## Questions?

This is a significant enhancement to help you track true investment performance. The system will:
- Automatically detect most transactions from CSV imports
- Require you to manually log deposits/withdrawals
- Calculate true gains excluding deposits

Would you like me to continue with the implementation?
